task generateFiles(description: "Generate <lib.os.arch>.bnd file for this host. This behaviour can be adjusted with environment variables (OS, ARCH, LIB, ...)", group: "build") {
	def inputTemplate = "generic.bnd.template"
	inputs.file inputTemplate
	outputs.file fileTree(dir: projectDir, include: "*.bnd", exclude: "bnd.bnd")
	outputs.upToDateWhen { false }
	doLast {
		copy {
			from inputTemplate
			into projectDir
			expand(project.properties)
			rename { file ->  "generic.bnd" }
			filter { String line ->
    			if (line.startsWith("##"))
    				"# Generated file. Do not edit this file."
    			else
    				line.startsWith('#') ? null : line
    		}
		}
		if (jenkins_build.equalsIgnoreCase("true")) {
			copy {
				from "generic.bnd"
				into projectDir
				rename { file ->  "${lib}.${os}.${arch}.bnd".toLowerCase() }
			}
		}
	}
}
compileJava.dependsOn(generateFiles)
processResources.dependsOn(generateFiles)

cleanAll.dependsOn(cleanGenerateFiles)
assemble.dependsOn(jar)
